const fs = require('fs');
const crypto = require('crypto');

// Datos del Excel (tab-separated)
const excelData = `12/03/2023	marzo	$8,650	$40,000	$200,000	$277,000		$0	$525,650
19/03/2023	marzo	$19,800	$10,000	$220,000	$329,000		$0	$578,800
26/03/2023	marzo	$12,100	$170,000	$220,000	$269,000		$0	$671,100
02/04/2023	abril	$51,250	$30,000	$220,000	$272,000		$0	$573,250
09/04/2023	abril	$44,200	$110,000	$300,000	$249,000		$0	$703,200
16/04/2023	abril	$10,000	$130,000	$300,000	$284,000		$0	$724,000
23/04/2023	abril	$55,000	$280,000	$300,000	$294,000		$0	$929,000
30/04/2023	abril	$51,250	$280,000	$300,000	$272,000		$0	$903,250
07/05/2023	mayo	$3,400	$80,000	$550,000	$282,000		$0	$915,400
14/05/2023	mayo	$6,300	$80,000	$550,000	$272,000		$0	$908,300
21/05/2023	mayo	$14,200	$80,000	$550,000	$272,000		$0	$916,200
28/05/2023	mayo	$12,350	$80,000	$550,000	$222,000		$0	$864,350
04/06/2023	junio	$1,350	$130,000	$550,000	$228,000		$0	$909,350
11/06/2023	junio	$25,000	$200,000	$550,000	$238,000		$0	$1,013,000
18/06/2023	junio	$28,700	$233,500	$550,000	$248,000		$0	$1,060,200
25/06/2023	junio	$3,900	$240,500	$612,000	$248,000		$0	$1,104,400
02/07/2023	julio	$21,200	$380,500	$612,000	$298,000		$0	$1,311,700
09/07/2023	julio	$21,500	$310,500	$612,000	$358,000		$0	$1,302,000
16/07/2023	julio	$84,000	$260,500	$612,000	$352,000		$0	$1,308,500
23/07/2023	julio	$84,000	$260,500	$612,000	$352,000		$0	$1,308,500
30/07/2023	julio	$13,000	$155,000	$612,000	$362,000		$0	$1,142,000
06/08/2023	agosto	$19,000	$100,000	$672,000	$422,000		$0	$1,213,000
13/08/2023	agosto	$46,000	$100,000	$672,000	$422,000		$0	$1,240,000
20/08/2023	agosto	$9,000	$125,000	$625,000	$422,000		$0	$1,181,000
27/08/2023	agosto	$9,000	$125,000	$625,000	$422,000		$0	$1,181,000
03/09/2023	septiembre	$12,000	$60,000	$653,000	$412,000		$0	$1,137,000
10/09/2023	septiembre	$10,000	$70,000	$616,000	$412,000		$0	$1,108,000
17/09/2023	septiembre	$1,500	$55,000	$642,000	$407,000		$0	$1,105,500
24/09/2023	septiembre	$6,000	$120,000	$662,000	$407,000		$0	$1,195,000
01/10/2023	octubre	$20,000	$129,000	$722,000	$397,000		$0	$1,268,000
08/10/2023	octubre	$14,000	$110,000	$727,000	$397,000		$0	$1,248,000
15/10/2023	octubre	$20,000	$160,000	$689,000	$397,000		$0	$1,266,000
22/10/2023	octubre	$26,000	$169,000	$764,000	$397,000		$0	$1,356,000
29/10/2023	octubre	$3,000	$153,000	$865,000	$397,000		$0	$1,418,000
05/11/2023	noviembre	$8,000	$153,000	$865,000	$409,000		$0	$1,435,000
12/11/2023	noviembre	$10,000	$145,000	$941,089	$237,000		$0	$1,333,089
19/11/2023	noviembre	$20,000	$111,000	$941,560	$237,000		$0	$1,309,560
26/11/2023	noviembre	$12,000	$120,000	$928,680	$237,000		$0	$1,297,680
03/12/2023	diciembre	$17,000	$190,000	$934,480	$237,000		$0	$1,378,480
10/12/2023	diciembre	$32,000	$120,000	$1,050,360	$237,000		$0	$1,439,360
17/12/2023	diciembre	$42,000	$196,000	$995,360	$237,000		$0	$1,470,360
24/12/2023	diciembre	$42,000	$196,000	$930,920	$237,000		$0	$1,405,920
31/12/2023	diciembre	$32,000	$176,000	$938,960	$391,000		$0	$1,537,960
07/01/2024	enero	$8,000	$252,000	$1,073,246	$391,000		$0	$1,724,246
14/01/2024	enero	$58,000	$245,000	$1,192,206	$347,000		$0	$1,842,206
21/01/2024	enero	$68,000	$345,000	$1,024,166	$247,000		$0	$1,684,166
28/01/2024	enero	$90,000	$285,000	$978,526	$247,000		$0	$1,600,526
04/02/2024	febrero	$93,000	$333,000	$1,060,680	$247,000		$0	$1,733,680
11/02/2024	febrero	$67,000	$327,000	$1,179,200	$292,000		$0	$1,865,200
18/02/2024	febrero	$50,000	$369,000	$1,048,840	$247,000		$0	$1,714,840
25/02/2024	febrero	$20,000	$169,000	$1,286,000	$247,000		$0	$1,722,000
03/03/2024	marzo	$10,000	$149,000	$1,716,000	$247,000		$0	$2,122,000
10/03/2024	marzo	$30,000	$149,000	$1,824,000	$247,000		$0	$2,250,000
17/03/2024	marzo	$50,000	$129,000	$1,312,000	$247,000		$0	$1,738,000
24/03/2024	marzo	$15,000	$129,000	$1,264,000	$247,000		$0	$1,655,000
31/03/2024	marzo	$20,000	$129,000	$1,280,000	$267,000		$0	$1,696,000
07/04/2024	abril	$15,000	$147,000	$1,282,000	$267,000		$0	$1,711,000
14/04/2024	abril	$15,000	$145,000	$896,000	$267,000		$0	$1,323,000
21/04/2024	abril	$10,000	$132,000	$944,000	$277,000		$0	$1,363,000
28/04/2024	abril	$45,000	$144,000	$984,000	$277,000		$0	$1,450,000
05/05/2024	mayo	$24,000	$184,000	$988,000	$277,000		$0	$1,473,000
12/05/2024	mayo	$12,000	$184,000	$928,000	$277,000		$0	$1,401,000
19/05/2024	mayo	$24,000	$184,000	$1,048,000	$277,000		$0	$1,533,000
26/05/2024	mayo	$10,000	$177,000	$1,100,000	$277,000		$0	$1,564,000
02/06/2024	junio	$24,000	$134,000	$1,112,000	$277,000		$0	$1,547,000
09/06/2024	junio	$6,000	$132,000	$1,048,000	$282,000		$0	$1,468,000
16/06/2024	junio	$12,000	$174,500	$968,000	$282,000		$0	$1,436,500
23/06/2024	junio	$50,000	$134,500	$896,000	$307,000		$0	$1,387,500
30/06/2024	junio	$36,000	$608,500	$999,680	$291,000		$0	$1,935,180
07/07/2024	julio	$17,000	$462,500	$799,400	$321,000		$0	$1,599,900
14/07/2024	julio	$10,000	$364,500	$804,000	$329,000		$0	$1,507,500
21/07/2024	julio	$23,150	$1,016,462	$1,199,520	$329,000		$0	$2,568,132
28/07/2024	julio	$60,150	$1,227,000	$1,581,520	$337,000		$0	$3,205,670
04/08/2024	agosto	$9,050	$802,200	$1,728,880	$337,000		$0	$2,877,130
11/08/2024	agosto	$32,000	$1,012,200	$2,006,680	$345,000		$0	$3,395,880
18/08/2024	agosto	$10,500	$422,200	$2,541,080	$345,000		$0	$3,318,780
25/08/2024	agosto	$3,850	$422,200	$2,754,880	$486,500		$0	$3,667,430
01/09/2024	septiembre	$3,250	$1,062,000	$2,738,000	$546,500		$0	$4,349,750
08/09/2024	septiembre	$19,250	$512,200	$2,972,000	$423,000		$0	$3,926,450
15/09/2024	septiembre	$10,000	$1,404,200	$3,264,000	$369,500		$0	$5,047,700
22/09/2024	septiembre	$10,000	$563,150	$3,760,000	$419,500		$0	$4,752,650
29/09/2024	septiembre	$1,900	$593,000	$4,232,000	$412,000		$0	$5,238,900
06/10/2024	octubre	$55,000	$443,100	$4,300,680	$451,500		$0	$5,250,280
13/10/2024	octubre	$50,000	$464,850	$4,069,120	$425,000		$0	$5,008,970
20/10/2024	octubre	$121,900	$948,650	$4,740,000	$425,250		$0	$6,235,800
27/10/2024	octubre	$2,000	$1,002,000	$4,064,000	$445,000		$0	$5,513,000
03/11/2024	noviembre	$148,000	$243,950	$4,644,200	$470,000		$0	$5,506,150
10/11/2024	noviembre	$2,000	$712,000	$6,090,000	$400,000		$0	$7,204,000
17/11/2024	noviembre	$20,000	$995,200	$7,190,000	$400,000		$0	$8,605,200
24/11/2024	noviembre	$6,000	$731,000	$8,948,000	$726,000		$0	$10,411,000
01/12/2024	diciembre	$2,000	$709,000	$10,524,000	$706,000		$0	$11,941,000
08/12/2024	diciembre	$6,000	$664,300	$12,492,000	$756,000		$0	$13,918,300
15/12/2024	diciembre	$57,000	$536,800	$12,644,000	$423,500		$0	$13,661,300
22/12/2024	diciembre	$302,500	$574,148	$10,648,000	$498,000		$0	$12,022,648
29/12/2024	diciembre	$50,000	$129,000	$9,748,000	$418,000		$0	$10,345,000
05/01/2025	enero	$55,000	$111,500	$11,488,000	$418,000		$0	$12,072,500
12/01/2025	enero	$852,000	$159,920	$10,596,000	$324,000		$0	$11,931,920
19/01/2025	enero	$773,000	$151,400	$12,696,000	$332,500		$0	$13,952,900
26/01/2025	enero	$450,000	$251,400	$10,620,000	$504,000		$0	$11,825,400
02/02/2025	febrero	$450,000	$225,400	$9,348,000	$513,000		$0	$10,536,400
09/02/2025	febrero	$25,000	$548,000	$8,516,000	$422,000		$2,280,000	$11,791,000
16/02/2025	febrero	$20,000	$768,000	$8,920,000	$422,000		$2,280,000	$12,410,000
23/02/2025	febrero	$112,000	$75,000	$7,928,000	$422,000		$2,280,000	$10,817,000
02/03/2025	marzo	$104,000	$75,000	$7,168,000	$422,000		$2,280,000	$10,049,000
09/03/2025	marzo	$70,000	$262,000	$6,076,000	$422,000		$2,280,000	$9,110,000
16/03/2025	marzo	$20,000	$187,000	$6,628,000	$324,000		$2,280,000	$9,439,000
23/03/2025	marzo	$42,000	$187,000	$7,096,000	$344,000		$2,280,000	$9,949,000
30/03/2025	marzo	$25,000	$196,000	$6,504,000	$344,000		$2,280,000	$9,349,000
06/04/2025	abril	$27,000	$177,000	$6,312,000	$344,000		$2,280,000	$9,140,000
13/04/2025	abril	$27,000	$177,000	$6,312,000	$344,000		$2,280,000	$9,140,000
20/04/2025	abril	$27,000	$177,000	$6,312,000	$344,000		$2,280,000	$9,140,000
27/04/2025	abril	$52,500	$891,000	$6,920,000	$359,000		$2,280,000	$10,502,500
04/05/2025	mayo	$52,500	$891,000	$6,920,000	$359,000		$2,280,000	$10,502,500
11/05/2025	mayo	$67,000	$867,000	$7,996,000	$359,000		$2,280,000	$11,569,000
18/05/2025	mayo	$70,000	$573,000	$7,644,000	$364,000		$2,280,000	$10,931,000
25/05/2025	mayo	$70,000	$573,000	$7,644,000	$364,000		$2,280,000	$10,931,000
01/06/2025	junio	$20,000	$211,000	$7,112,000	$364,000		$2,280,000	$9,987,000
08/06/2025	junio	$24,000	$192,000	$6,588,000	$399,000		$2,280,000	$9,483,000
15/06/2025	junio	$24,000	$192,000	$6,588,000	$399,000		$2,280,000	$9,483,000
22/06/2025	junio	$24,000	$192,000	$6,588,000	$399,000		$2,280,000	$9,483,000
29/06/2025	junio	$0	$253,000	$6,600,000	$498,050		$2,280,000	$9,631,050
06/07/2025	julio	$24,000	$253,000	$6,600,000	$498,050		$2,280,000	$9,655,050
13/07/2025	julio	$15,850	$577,000	$7,339,280	$506,050		$2,280,000	$10,718,180
20/07/2025	julio	$0	$560,000	$9,236,000	$506,050		$2,280,000	$12,582,050
27/07/2025	julio	$0	$201,000	$7,308,000	$399,800		$3,180,000	$11,088,800
03/08/2025	agosto	$0	$201,000	$8,064,000	$799,800		$3,180,000	$12,244,800
10/08/2025	agosto	$0	$201,000	$8,064,000	$799,800		$3,180,000	$12,244,800
17/08/2025	agosto	$150,000	$888,000	$8,584,000	$799,800		$3,180,000	$13,601,800
24/08/2025	agosto	$0	$811,000	$7,541,637	$832,000		$3,180,000	$12,364,637
31/08/2025	agosto	$0	$811,000	$7,541,637	$745,800		$3,180,000	$12,278,437
07/09/2025	septiembre	$0	$470,000	$7,744,000	$745,800		$3,180,000	$12,139,800
14/09/2025	septiembre	$0	$586,000	$8,576,000	$745,800		$3,180,000	$13,087,800
21/09/2025	septiembre	$0	$249,001	$6,892,000	$853,800			$7,994,801`;

/**
 * Genera un UUID v4
 */
function generateUUID() {
    return crypto.randomUUID();
}

/**
 * Parsea un valor monetario (elimina $, comas y convierte a nÃºmero)
 */
function parseMoneyValue(value) {
    if (!value || value.trim() === '') return 0;
    return parseInt(value.replace(/\$|,/g, ''), 10);
}

/**
 * Convierte fecha de formato DD/MM/YYYY a YYYY-MM-DD
 */
function convertDate(dateStr) {
    const [day, month, year] = dateStr.split('/');
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
}

/**
 * Procesa una lÃ­nea del Excel y convierte a formato snapshot
 */
function processRow(row) {
    const columns = row.split('\t');

    // Ãndices: 0=Date, 1=Month, 2=Cash, 3=Bank, 4=Investments, 5=Loan, 6=Borrowed, 7=Estate, 8=Patrimony
    const date = convertDate(columns[0]);
    const cash = parseMoneyValue(columns[2]);
    const bank = parseMoneyValue(columns[3]);
    const investments = parseMoneyValue(columns[4]);
    const loan = parseMoneyValue(columns[5]);
    const borrowed = parseMoneyValue(columns[6]);
    const estate = parseMoneyValue(columns[7]);
    const patrimony = parseMoneyValue(columns[8]);

    // Crear objeto values solo con los campos que tienen valor
    const values = {};

    if (cash > 0) values['Efectivo'] = cash;
    if (bank > 0) values['Caja Fuerte'] = bank;
    if (investments > 0) values['Inversiones'] = investments;
    if (loan > 0) values['Loan'] = loan;
    if (borrowed > 0) values['Borrowed'] = borrowed;
    if (estate > 0) values['Estate'] = estate;

    return {
        id: generateUUID(),
        date: date,
        values: values,
        patrimonio: patrimony,
        currency: 'COP',
        note: ''
    };
}

/**
 * FunciÃ³n principal de migraciÃ³n
 */
function migrateData() {
    console.log('ğŸš€ Iniciando migraciÃ³n de datos...\n');

    // Parsear datos del Excel
    const rows = excelData.trim().split('\n');
    console.log(`ğŸ“Š Total de filas a procesar: ${rows.length}\n`);

    // Convertir cada fila a snapshot
    const snapshots = rows.map((row, index) => {
        const snapshot = processRow(row);
        console.log(`âœ… Procesada fila ${index + 1}: ${snapshot.date} - Patrimonio: $${snapshot.patrimonio.toLocaleString()}`);
        return snapshot;
    });

    // Ordenar snapshots por fecha (mÃ¡s antiguos primero)
    snapshots.sort((a, b) => new Date(a.date) - new Date(b.date));

    // Leer el archivo ledger.json actual
    const ledgerPath = './.finance-db/ledger.json';
    const ledger = JSON.parse(fs.readFileSync(ledgerPath, 'utf-8'));

    // Actualizar snapshots
    ledger.snapshots = snapshots;

    // Escribir el archivo actualizado
    fs.writeFileSync(ledgerPath, JSON.stringify(ledger, null, 2), 'utf-8');

    console.log(`\nâœ¨ MigraciÃ³n completada exitosamente!`);
    console.log(`ğŸ“ Total de snapshots migrados: ${snapshots.length}`);
    console.log(`ğŸ“… Rango de fechas: ${snapshots[0].date} a ${snapshots[snapshots.length - 1].date}`);
    console.log(`ğŸ’¾ Archivo actualizado: ${ledgerPath}`);
}

// Ejecutar migraciÃ³n
try {
    migrateData();
} catch (error) {
    console.error('âŒ Error durante la migraciÃ³n:', error);
    process.exit(1);
}
